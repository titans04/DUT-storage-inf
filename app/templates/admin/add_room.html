{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  :root{
    --dut-navy:#001F3F;--dut-maroon:#800000;--dut-light:#f8f9fa;
    --text-primary:#1a1a1a;--text-secondary:#555;--border-color:#e8eef5;
    --success:#198754;--danger:#dc3545;--warning:#ffc107;--info:#0dcaf0;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:linear-gradient(135deg,#f5f7fa 0%,#e9ecf1 100%);
    min-height:100vh;color:var(--text-primary);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .container-fluid{max-width:1000px;padding:1rem;}

  .header-section{background:#fff;padding:1.75rem;border-radius:12px;
    box-shadow:0 2px 8px rgba(0,31,63,.06);margin-bottom:2rem;
    border-top:4px solid var(--dut-navy);}
  .header-top{display:flex;justify-content:space-between;align-items:center;
    flex-wrap:wrap;gap:1.5rem;}
  .header-content h1{font-size:2rem;font-weight:700;color:var(--dut-navy);
    display:flex;align-items:center;gap:.75rem;margin:0;}
  .header-content h1 i{color:var(--dut-maroon);font-size:2rem;}
  .header-content p{color:var(--text-secondary);margin-top:.5rem;font-size:.95rem;}

  .btn{padding:.75rem 1.5rem;border:none;border-radius:8px;
    font-weight:600;cursor:pointer;transition:all .3s ease;
    text-decoration:none;display:inline-flex;align-items:center;
    gap:.5rem;font-size:.95rem;}
  .btn-secondary{background:#fff;color:var(--dut-navy);
    border:2px solid var(--dut-navy);}
  .btn-secondary:hover{background:var(--dut-navy);color:#fff;}
  .btn-primary{background:var(--dut-maroon);color:#fff;width:100%;}
  .btn-primary:hover{background:#6a0000;transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(128,0,0,.2);}

  .alert{border-radius:8px;border:none;padding:1rem 1.25rem;
    margin-bottom:1.5rem;display:flex;align-items:center;gap:.75rem;}
  .alert-info{background:#cfe2ff;color:#084298;}
  .alert-success{background:#d1e7dd;color:#0f5132;}
  .alert-danger{background:#f8d7da;color:#842029;}
  .btn-close{background:none;border:none;font-size:1.25rem;
    cursor:pointer;opacity:.6;margin-left:auto;}
  .btn-close:hover{opacity:1;}

  .card{background:#fff;border-radius:12px;border:1px solid var(--border-color);
    box-shadow:0 2px 8px rgba(0,0,0,.04);overflow:hidden;margin-bottom:1.5rem;}
  .card-header{background:linear-gradient(135deg,var(--dut-navy) 0%,#000d2e 100%);
    color:#fff;padding:1.5rem;}
  .card-header h5{margin:0;font-size:1.2rem;font-weight:700;
    display:flex;align-items:center;gap:.75rem;}
  .card-body{padding:1.75rem;}

  .form-section{margin-bottom:2rem;}
  .form-section-header{font-size:1.1rem;font-weight:700;
    display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;
    padding-bottom:1rem;border-bottom:2px solid var(--border-color);
    color:var(--dut-navy);}
  .form-section-header i{color:var(--dut-maroon);}
  .form-label{font-weight:600;color:var(--dut-navy);margin-bottom:.75rem;
    display:flex;align-items:center;gap:.5rem;font-size:.95rem;}
  .form-control,.form-select{
    border:2px solid var(--border-color);border-radius:8px;
    padding:.875rem;font-size:1rem;color:var(--text-primary);
    transition:all .3s ease;width:100%;}
  .form-control:focus,.form-select:focus{
    border-color:var(--dut-navy);outline:none;
    box-shadow:0 0 0 3px rgba(0,31,63,.1);}
  .form-group{display:flex;flex-direction:column;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
  .error-text{color:var(--danger);font-size:.85rem;margin-top:.5rem;
    display:flex;align-items:center;gap:.4rem;}
  .divider{height:1px;background:var(--border-color);margin:2rem 0;}

  .faculty-other {
    display: none;
    margin-top: 0.75rem;
    transition: all 0.3s ease;
  }
  .faculty-other.show {
    display: block;
  }

  @media (max-width:1024px){
    .header-content h1{font-size:1.75rem;}
  }
  @media (max-width:768px){
    .container-fluid{padding:.75rem;}
    .header-section{padding:1.25rem;margin-bottom:1.5rem;}
    .header-top{flex-direction:column;gap:1rem;}
    .header-content h1{font-size:1.4rem;gap:.5rem;}
    .header-content h1 i{font-size:1.4rem;}
    .btn{width:100%;justify-content:center;}
    .card-body{padding:1.25rem;}
    .form-section{margin-bottom:1.5rem;}
    .form-section-header{font-size:1rem;margin-bottom:1rem;padding-bottom:.75rem;}
    .form-label{font-size:.9rem;margin-bottom:.5rem;}
    .form-control,.form-select{padding:.75rem;font-size:.95rem;}
    .divider{margin:1.5rem 0;}
    .form-row{grid-template-columns:1fr;}
  }
  @media (max-width:480px){
    .header-section{padding:1rem;}
    .header-content h1{font-size:1.2rem;}
    .card-header h5{font-size:1rem;gap:.5rem;}
    .btn{padding:.65rem 1rem;font-size:.85rem;}
    .card-body{padding:1rem;}
    .form-section-header{font-size:.95rem;margin-bottom:.75rem;padding-bottom:.5rem;}
    .form-label{font-size:.85rem;}
    .form-control,.form-select{padding:.65rem;font-size:.9rem;}
  }

  .btn:focus,a:focus{outline:2px solid var(--dut-navy);outline-offset:2px;}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const facultySelect = document.getElementById('faculty');
    const otherContainer = document.querySelector('.faculty-other');

    function toggleOther() {
      if (facultySelect.value === 'other') {
        otherContainer.classList.add('show');
        setTimeout(() => otherContainer.querySelector('input').focus(), 150);
      } else {
        otherContainer.classList.remove('show');
        otherContainer.querySelector('input').value = '';
      }
    }

    if (facultySelect) {
      facultySelect.addEventListener('change', toggleOther);
      toggleOther(); // initial check
    }
  });
</script>
{% endblock %}

{% block title %}Add New Room{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- SMART BACK URL -->
  {% set back_url = (
      request.referrer
      if request.referrer and (request.referrer.startswith(request.url_root + 'capturer/') or request.referrer.startswith(request.url_root + 'admin/'))
      else (url_for('capturer.dashboard') if current_user.is_data_capturer else url_for('admin.list_rooms'))
  ) %}

  <!-- Header -->
  <div class="header-section">
    <div class="header-top">
      <div class="header-content">
        <h1><i class="fas fa-door-open"></i>Add New Room</h1>
        <p class="text-muted mb-0">
          {% if current_user.is_data_capturer %}
            Assign a room and specify its responsible staff member.
          {% else %}
            Assign a new room to one of your managed campuses.
          {% endif %}
        </p>
      </div>
      <a href="{{ back_url }}" class="btn btn-secondary">
        <i class="fas fa-times-circle"></i>Cancel
      </a>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">
          <i class="fas fa-{% if category == 'danger' %}exclamation-circle
                          {% elif category == 'success' %}check-circle
                          {% else %}info-circle{% endif %}"></i>
          <span>{{ message }}</span>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">×</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Form Card -->
  <div class="card">
    <div class="card-header">
      <h5><i class="fas fa-building"></i>Room Details</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('admin.add_room') }}">
        {{ form.hidden_tag() }}

        <!-- SECTION 1: Location & Identity -->
        <div class="form-section">
          <div class="form-section-header">
            <span class="step-number">1</span>
            <i class="fas fa-location-dot"></i>Location & Identity
          </div>

          <div class="form-group">
            <label for="{{ form.campus.id }}" class="form-label">
              <i class="fas fa-school"></i> {{ form.campus.label }} <span class="required">*</span>
            </label>
            {{ form.campus(class="form-select") }}
            {% for error in form.campus.errors %}
              <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
            {% endfor %}
          </div>

          <div class="form-group">
            <label for="{{ form.name.id }}" class="form-label">
              <i class="fas fa-door-closed"></i> {{ form.name.label }} <span class="required">*</span>
            </label>
            {{ form.name(class="form-control", placeholder="e.g., IT Lab 201") }}
            {% for error in form.name.errors %}
              <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
            {% endfor %}
          </div>

          <div class="form-group">
            <label for="{{ form.description.id }}" class="form-label">
              <i class="fas fa-align-left"></i> {{ form.description.label }}
            </label>
            {{ form.description(class="form-control", rows="3", placeholder="Optional description...") }}
          </div>
        </div>

        <div class="divider"></div>

        <!-- SECTION 2: Faculty Assignment -->
        <div class="form-section">
          <div class="form-section-header">
            <span class="step-number">2</span>
            <i class="fas fa-university"></i>Faculty Assignment
          </div>

          <div class="form-group">
            <label for="faculty" class="form-label">
              <i class="fas fa-graduation-cap"></i> {{ form.faculty.label }}
            </label>
            {{ form.faculty(class="form-select", id="faculty") }}
            <div class="faculty-other">
              {{ form.faculty_other(class="form-control", placeholder="Enter new faculty name...") }}
              {% for error in form.faculty_other.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>

        {% if current_user.is_data_capturer %}
        <div class="divider"></div>

        <!-- SECTION 3 (was 4): Responsible Staff – only for capturers -->
        <div class="form-section">
          <div class="form-section-header">
            <span class="step-number">3</span>
            <i class="fas fa-user-tie"></i>Responsible Staff
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.staff_name.id }}" class="form-label">
                <i class="fas fa-user"></i> {{ form.staff_name.label }} <span class="required">*</span>
              </label>
              {{ form.staff_name(class="form-control", placeholder="Full name") }}
              {% for error in form.staff_name.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>

            <div class="form-group">
              <label for="{{ form.staff_number.id }}" class="form-label">
                <i class="fas fa-id-badge"></i> {{ form.staff_number.label }} <span class="required">*</span>
              </label>
              {{ form.staff_number(class="form-control", placeholder="e.g., S123456") }}
              {% for error in form.staff_number.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Submit / Cancel -->
        <div style="margin-top:2rem;border-top:1px solid var(--border-color);padding-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check-circle"></i> Create Room
          </button>
          <a href="{{ back_url }}" class="btn btn-secondary" style="width:auto;">
            <i class="fas fa-arrow-left"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}