{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
    :root {
        --dut-navy: #001F3F;
        --dut-maroon: #800000;
        --border-color: #e8eef5;
        --bg-light: #f8f9fa;
        --success: #198754;
        --warning: #ffc107;
        --danger: #dc3545;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2.1rem;
        color: var(--dut-navy);
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #f0f4fa 100%);
        border-radius: 14px;
        padding: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
        margin-bottom: 2rem;
    }

    .filter-section h5 {
        color: var(--dut-navy);
        font-weight: 700;
        font-size: 1.3rem;
        border-bottom: 3px solid var(--dut-navy);
        padding-bottom: 0.75rem;
        margin-bottom: 1.75rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dut-navy);
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--dut-navy);
        box-shadow: 0 0 0 4px rgba(0, 31, 63, 0.12);
    }

    .btn-filter {
        background: var(--dut-navy);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
    }

    .btn-filter:hover {
        background: #000d2e;
        transform: translateY(-2px);
    }

    .card {
        border: 1px solid var(--border-color);
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, var(--dut-navy) 0%, #000d2e 100%);
        color: white;
        padding: 1.6rem;
    }

    .card-header h5 {
        margin: 0;
        font-weight: 700;
        font-size: 1.35rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .export-card {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid var(--dut-navy);
    }

    .export-card .card-header {
        background: var(--dut-navy);
    }

    .form-check-input:checked {
        background-color: var(--dut-navy);
        border-color: var(--dut-navy);
    }

    .table { margin: 0; font-size: 0.94rem; }
    .table thead th { color: var(--dut-navy); font-weight: 700; border: none; padding: 1rem; background: #f8f9fa; }
    .table tbody td { padding: 1rem; vertical-align: middle; }
    .table tbody tr:hover { background: rgba(0, 31, 63, 0.04); }

    .item-name { font-weight: 600; color: var(--dut-navy); }
    code { background: #f1f3f5; color: var(--dut-navy); padding: 0.25rem 0.55rem; border-radius: 6px; font-size: 0.88rem; font-weight: 600; }
    .badge { padding: 0.5rem 0.9rem; border-radius: 8px; font-weight: 600; font-size: 0.82rem; }
    .badge-active   { background: #198754; color: white; }
    .badge-inactive { background: #6c757d; color: white; }
    .badge-repair   { background: #ffc107; color: #000; }
    .badge-disposed { background: #dc3545; color: white; }
    .badge-stolen   { background: #6f42c1; color: white; }
    .badge-category { background: #0d6efd; color: white; }
    .cost-display { font-weight: 600; }
    .cost-missing { background: #fff3cd; color: #856404; padding: 0.35rem 0.7rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
    .staff-info strong { color: var(--dut-navy); }
    .staff-info small { color: #6c757d; }

    .btn-edit {
        background: var(--dut-navy);
        color: white;
        padding: 0.55rem 1rem;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .btn-edit:hover {
        background: #000d2e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 31, 63, 0.3);
        color: white;
    }

    .no-items { text-align: center; padding: 5rem 2rem; color: #6c757d; }
    .no-items i { font-size: 5rem; opacity: 0.15; margin-bottom: 1.5rem; }

    @media (max-width: 992px) {
        .filter-section { padding: 1.5rem; }
        .page-header { flex-direction: column; text-align: center; }
        .table thead { display: none; }
        .table tbody tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem; background: white; }
        .table tbody td { display: block; text-align: right; padding: 0.5rem 0; border: none; }
        .table tbody td::before { content: attr(data-label); float: left; font-weight: 600; color: var(--dut-navy); }
    }
</style>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <div class="page-header">
        <div>
            <h1><i class="fas fa-warehouse"></i> Inventory Dashboard</h1>
            <p>Advanced inventory management with real-time filtering across all campuses</p>
        </div>
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-warning">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show rounded-3 mb-4" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- EXPORT CARD WITH COLUMN SELECTION -->
    <div class="card export-card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-download"></i> Export Inventory</h5>
        </div>
        <div class="card-body">
            <form method="GET" id="exportForm">
                <!-- Preserve all current filters -->
                {% for key, value in request.args.items() %}
                    {% if key != 'columns' and key != 'format' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}

                <div class="row">
                    <div class="col-lg-8">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-columns"></i> Select columns to export:
                        </label>
                        <div class="row">
                            {% set columns = [
                                ("Asset No.", "Asset No."),
                                ("Serial No.", "Serial No."),
                                ("Name", "Item Name"),
                                ("Brand", "Brand"),
                                ("Color", "Color"),
                                ("Capacity/Specs", "Specs"),
                                ("Category", "Category"),
                                ("Cost (R)", "Cost"),
                                ("Status", "Status"),
                                ("Captured By", "Captured By"),
                                ("Room", "Room"),
                                ("Campus", "Campus"),
                                ("Room Staff", "Room Staff"),
                                ("Staff ID", "Staff ID"),
                                ("Procured Date", "Procured Date"),
                                ("Allocated Date", "Allocated Date"),
                                ("Captured Date", "Captured Date")
                            ] %}
                            {% for col_key, col_label in columns %}
                                <div class="col-md-4 col-sm-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="columns" value="{{ col_key }}" 
                                               id="col_{{ loop.index }}"
                                               {% if col_key in ["Asset No.", "Name", "Status", "Room", "Campus"] or not request.args.getlist('columns') %}checked{% endif %}>
                                        <label class="form-check-label" for="col_{{ loop.index }}">
                                            {{ col_label }}
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Name & Status are always included for summary. Uncheck others to exclude.
                        </small>
                    </div>

                    <div class="col-lg-4 d-flex align-items-end">
                        <div class="btn-group w-100">
                            <button type="submit" 
                                    formaction="{{ url_for('admin.export_items', format='xlsx') }}" 
                                    class="btn btn-success btn-lg flex-fill">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button type="submit" 
                                    formaction="{{ url_for('admin.export_items', format='pdf') }}" 
                                    class="btn btn-danger btn-lg flex-fill">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- FILTERS -->
    <div class="filter-section">
        <form method="GET" action="{{ url_for('admin.view_inventory') }}" id="inventory-filter-form">
            <h5><i class="fas fa-filter"></i> Advanced Filters</h5>

            <div class="row g-3 mb-3">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Campus</label>
                    <select class="form-select" name="campus_id" onchange="this.form.submit()">
                        <option value="">All Campuses</option>
                        {% for campus in managed_campuses %}
                            <option value="{{ campus.campus_id }}" {% if current_filters.campus_id == campus.campus_id|string %}selected{% endif %}>{{ campus.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Room</label>
                    <select class="form-select" name="room_id" onchange="this.form.submit()">
                        <option value="">All Rooms</option>
                        {% for room in managed_rooms %}
                            <option value="{{ room.room_id }}" {% if current_filters.room_id == room.room_id|string %}selected{% endif %}>{{ room.campus.name }} – {{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status" onchange="this.form.submit()">
                        <option value="all">All Statuses</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category" onchange="this.form.submit()">
                        <option value="all">All Categories</option>
                        {% for value, label in category_choices %}
                            <option value="{{ value }}" {% if current_filters.category == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Responsible Staff</label>
                    <input type="text" class="form-control" name="staff" placeholder="Name or Staff ID" value="{{ current_filters.staff | default('', true) }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Data Capturer</label>
                    <input type="text" class="form-control" name="capturer" placeholder="Name or Student No." value="{{ current_filters.capturer | default('', true) }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Cost Range (R)</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" step="0.01" min="0" class="form-control" name="min_cost" placeholder="Min" value="{{ current_filters.min_cost | default('', true) }}">
                        </div>
                        <div class="col-6">
                            <input type="number" step="0.01" min="0" class="form-control" name="max_cost" placeholder="Max" value="{{ current_filters.max_cost | default('', true) }}">
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Procured Date</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="date" class="form-control" name="date_from" value="{{ current_filters.date_from | default('', true) }}">
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" name="date_to" value="{{ current_filters.date_to | default('', true) }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Allocated From</label>
                    <input type="date" class="form-control" name="alloc_from" value="{{ current_filters.alloc_from | default('', true) }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label">Allocated To</label>
                    <input type="date" class="form-control" name="alloc_to" value="{{ current_filters.alloc_to | default('', true) }}">
                </div>
                <div class="col-lg-6 d-flex align-items-end justify-content-end gap-2">
                    <button type="submit" class="btn btn-filter">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    <a href="{{ url_for('admin.view_inventory') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear All
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- INVENTORY TABLE -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list-ul"></i> Inventory Records ({{ items|length }})</h5>
        </div>
        <div class="card-body p-0">
            {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Asset #</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Brand / Color</th>
                                <th>Serial #</th>
                                <th>Location</th>
                                <th>Responsible Staff</th>
                                <th>Status</th>
                                <th>Cost</th>
                                <th>Captured By</th>
                                <th>Procured</th>
                                <th>Allocated</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td data-label="Asset #"><code class="text-primary fw-bold">{{ item.asset_number or '—' }}</code></td>
                                <td data-label="Item Name" class="item-name">{{ item.name }}</td>
                                <td data-label="Category"><span class="badge badge-category">{{ item.category.value }}</span></td>
                                <td data-label="Brand/Color">
                                    {% if item.brand or item.color %}
                                        <small>
                                            {% if item.brand %}<strong>{{ item.brand }}</strong>{% endif %}
                                            {% if item.color %}<br><span class="text-muted">{{ item.color }}</span>{% endif %}
                                        </small>
                                    {% else %}—
                                    {% endif %}
                                </td>
                                <td data-label="Serial #">{% if item.serial_number %}<code>{{ item.serial_number }}</code>{% else %}—{% endif %}</td>
                                <td data-label="Location">
                                    <strong>{{ item.room.campus.name }}</strong><br>
                                    <small class="text-muted">{{ item.room.name }}</small>
                                </td>
                                <td data-label="Responsible Staff" class="staff-info">
                                    {% if item.room.staff_name or item.room.staff_number %}
                                        <strong>{{ item.room.staff_name or "No Name" }}</strong>
                                        {% if item.room.staff_number %}<br><small>ID: {{ item.room.staff_number }}</small>{% endif %}
                                    {% else %}
                                        <span class="text-muted">Not Assigned</span>
                                    {% endif %}
                                </td>
                                <td data-label="Status">
                                    <span class="badge {{ {'ACTIVE':'badge-active','INACTIVE':'badge-inactive','NEEDS_REPAIR':'badge-repair','DISPOSED':'badge-disposed','STOLEN':'badge-stolen'}[item.status.name] }}">
                                        {{ item.status.value }}
                                    </span>
                                </td>
                                <td data-label="Cost">
                                    {% if item.cost and item.cost > 0 %}
                                        <strong>R{{ "%.2f"|format(item.cost) }}</strong>
                                    {% else %}
                                        <span class="cost-missing">Not Set</span>
                                    {% endif %}
                                </td>
                                <td data-label="Captured By"><small>{{ item.data_capturer.full_name if item.data_capturer else '—' }}</small></td>
                                <td data-label="Procured"><small>{{ item.Procured_date.strftime('%Y-%m-%d') if item.Procured_date else '—' }}</small></td>
                                <td data-label="Allocated">
                                    <small>
                                        {% if item.allocated_date %}
                                            <strong>{{ item.allocated_date.strftime('%Y-%m-%d') }}</strong>
                                        {% else %}
                                            <span class="text-muted">Not Allocated</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td data-label="Action">
                                    <a href="{{ url_for('admin.edit_item', item_id=item.item_id) }}" class="btn-edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-items">
                    <i class="fas fa-box-open"></i>
                    <h4>No items match your filters</h4>
                    <p>Try adjusting the filters or <a href="{{ url_for('admin.view_inventory') }}">clear all</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}