{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
<style>
    :root {
        --dut-navy: #001F3F;
        --dut-maroon: #800000;
        --border-color: #e8eef5;
    }

    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #f0f4fa 100%);
        border-radius: 10px;
        padding: 1.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid var(--border-color);
        margin-bottom: 2rem;
    }

    .filter-section h5 {
        color: var(--dut-navy);
        font-weight: 700;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dut-navy);
        margin-bottom: 0.5rem;
    }

    .form-select, .form-control {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--dut-navy);
        box-shadow: 0 0 0 3px rgba(0, 31, 63, 0.1);
        outline: none;
    }

    .btn-filter {
        background: var(--dut-navy);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-filter:hover {
        background: #000d2e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 31, 63, 0.2);
    }

    .btn-outline-secondary {
        border: 2px solid var(--border-color);
        color: var(--dut-navy);
    }

    .btn-outline-secondary:hover {
        background: var(--dut-navy);
        color: white;
    }

    .btn-success, .btn-danger {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-success:hover, .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .card {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, var(--dut-navy) 0%, #000d2e 100%);
        color: white;
        padding: 1.5rem;
        border: none;
    }

    .card-header h5 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .table {
        margin-bottom: 0;
        font-size: 0.95rem;
    }

    .table thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #f0f4fa 100%);
        border-bottom: 2px solid var(--border-color);
    }

    .table thead th {
        color: var(--dut-navy);
        font-weight: 700;
        padding: 1rem;
        border: none;
    }

    .table tbody td {
        padding: 0.85rem 1rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background: rgba(0, 31, 63, 0.02);
    }

    .asset-code {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 0.4rem 0.6rem;
        border-radius: 4px;
        font-weight: 600;
        color: var(--dut-navy);
    }

    .item-name {
        font-weight: 600;
        color: var(--dut-navy);
    }

    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .badge-active {
        background: #198754;
        color: white;
    }

    .badge-inactive {
        background: #6c757d;
        color: white;
    }

    .badge-repair {
        background: #ffc107;
        color: #000;
    }

    .badge-disposed {
        background: #dc3545;
        color: white;
    }

    .badge-stolen {
        background: #6f42c1;
        color: white;
    }

    .text-muted-small {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .price-missing {
        background: #fff3cd;
        color: #856404;
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .disposal-reason {
        max-width: 250px;
        word-wrap: break-word;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .btn-edit {
        background: var(--dut-navy);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }

    .btn-edit:hover {
        background: #000d2e;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 31, 63, 0.2);
        color: white;
    }

    .no-items {
        padding: 3rem;
        text-align: center;
        color: #6c757d;
    }

    .no-items i {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
        display: block;
    }

    @media (max-width: 1200px) {
        .table-responsive {
            font-size: 0.9rem;
        }

        .table thead th, .table tbody td {
            padding: 0.75rem 0.6rem;
        }

        .disposal-reason {
            max-width: 150px;
        }
    }

    @media (max-width: 768px) {
        .filter-section {
            padding: 1.25rem;
        }

        .btn-group-export {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .table thead th, .table tbody td {
            padding: 0.6rem 0.5rem;
        }

        .btn-edit {
            padding: 0.35rem 0.65rem;
            font-size: 0.8rem;
        }

        .disposal-reason {
            max-width: 100px;
        }
    }
</style>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- HEADER -->
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; color: var(--dut-navy); font-weight: 700; display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
            <i class="fas fa-boxes"></i>{{ title }}
        </h1>
        <p style="color: #6c757d; margin: 0;">Manage and track all inventory items across managed campuses</p>
    </div>

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="border-radius: 8px; margin-bottom: 1.5rem;">
                <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- FILTER SECTION -->
    <div class="filter-section">
        <form method="GET" action="{{ url_for('admin.view_inventory') }}" id="inventory-filter-form">
            <h5>
                <i class="fas fa-filter"></i>Filter Inventory Records
            </h5>
            
            <div class="row g-3">
                <!-- Campus Filter -->
                <div class="col-lg-3 col-md-6">
                    <label for="campus_id" class="form-label">Campus</label>
                    <select class="form-select" id="campus_id" name="campus_id" onchange="this.form.submit()">
                        <option value="">All Managed Campuses</option>
                        {% for campus in managed_campuses %}
                            <option value="{{ campus.campus_id }}" 
                                {% if current_filters.campus_id == campus.campus_id %}selected{% endif %}>
                                {{ campus.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Room Filter -->
                <div class="col-lg-3 col-md-6">
                    <label for="room_id" class="form-label">Room</label>
                    <select class="form-select" id="room_id" name="room_id" onchange="this.form.submit()">
                        <option value="">All Rooms</option>
                        {% for room in managed_rooms %}
                            <option value="{{ room.room_id }}" 
                                {% if current_filters.room_id == room.room_id %}selected{% endif %}>
                                {{ room.campus.name }} - {{ room.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-lg-3 col-md-6">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status" onchange="this.form.submit()">
                        <option value="all">All Statuses</option>
                        {% for name, label in status_choices %}
                            <option value="{{ name }}" 
                                {% if current_filters.status == name %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Data Capturer Search -->
                <div class="col-lg-3 col-md-6">
                    <label for="capturer" class="form-label">Data Capturer</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="capturer" name="capturer" 
                               placeholder="Name or Student ID" value="{{ current_filters.capturer | default('', true) }}">
                        <button class="btn btn-filter" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-3 align-items-center">
                <div class="col-md-12">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                        <a href="{{ url_for('admin.view_inventory') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-1"></i>Reset Filters
                        </a>
                        <a href="{{ url_for('admin.export_items', format='xlsx') }}?{{ request.query_string.decode() }}" class="btn btn-success">
                            <i class="fas fa-file-excel me-1"></i>Export Excel
                        </a>
                        <a href="{{ url_for('admin.export_items', format='pdf') }}?{{ request.query_string.decode() }}" class="btn btn-danger">
                            <i class="fas fa-file-pdf me-1"></i>Export PDF
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- INVENTORY TABLE -->
    <div class="card">
        <div class="card-header">
            <h5>
                <i class="fas fa-list"></i>Inventory Records ({{ items | length }})
            </h5>
        </div>
        <div class="card-body p-0">
            {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Asset #</th>
                                <th>Item Name</th>
                                <th>Brand / Color</th>
                                <th>Serial #</th>
                                <th>Description</th>
                                <th>Campus / Room</th>
                                <th>Status</th>
                                <th>Price</th>
                                <th>Captured By</th>
                                <th>Capture Date</th>
                                <th>Disposal Info</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <!-- Asset Number -->
                                <td>
                                    <span class="asset-code">{{ item.asset_number }}</span>
                                </td>

                                <!-- Item Name -->
                                <td>
                                    <span class="item-name">{{ item.name }}</span>
                                </td>

                                <!-- Brand & Color -->
                                <td>
                                    {% if item.brand or item.color %}
                                        <div class="text-muted-small">
                                            {% if item.brand %}<strong>{{ item.brand }}</strong>{% endif %}
                                            {% if item.brand and item.color %}<br>{% endif %}
                                            {% if item.color %}<span>{{ item.color }}</span>{% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted-small">—</span>
                                    {% endif %}
                                </td>

                                <!-- Serial Number -->
                                <td>
                                    {% if item.serial_number %}
                                        <code style="background: #f8f9fa; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.85rem;">
                                            {{ item.serial_number }}
                                        </code>
                                    {% else %}
                                        <span class="text-muted-small">—</span>
                                    {% endif %}
                                </td>

                                <!-- Description -->
                                <td>
                                    {% if item.description %}
                                        <span class="text-muted-small" title="{{ item.description }}" style="display: block; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            {{ item.description[:50] }}{% if item.description | length > 50 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted-small">—</span>
                                    {% endif %}
                                </td>

                                <!-- Campus / Room -->
                                <td>
                                    <div>
                                        <strong style="color: var(--dut-navy);">{{ item.room.campus.name }}</strong>
                                        <br>
                                        <span class="text-muted-small">{{ item.room.name }}</span>
                                    </div>
                                </td>

                                <!-- Status Badge -->
                                <td>
                                    {% set status_badge = {
                                        'ACTIVE': 'badge-active',
                                        'INACTIVE': 'badge-inactive',
                                        'NEEDS_REPAIR': 'badge-repair',
                                        'DISPOSED': 'badge-disposed',
                                        'STOLEN': 'badge-stolen'
                                    }.get(item.status.name, 'badge-inactive') %}
                                    <span class="badge {{ status_badge }}">
                                        {{ item.status.value }}
                                    </span>
                                </td>

                                <!-- Price -->
                                <td>
                                    {% if item.price and item.price|float > 0 %}
                                        <strong>R{{ "{:,.2f}".format(item.price) }}</strong>
                                    {% else %}
                                        <span class="price-missing">Missing</span>
                                    {% endif %}
                                </td>

                                <!-- Captured By -->
                                <td>
                                    <span class="text-muted-small">{{ item.data_capturer.full_name if item.data_capturer else '—' }}</span>
                                </td>

                                <!-- Capture Date -->
                                <td>
                                    <span class="text-muted-small">{{ item.capture_date.strftime('%Y-%m-%d') }}</span>
                                </td>

                                <!-- Disposal Info -->
                                <td>
                                    {% if item.status.name == 'DISPOSED' %}
                                        <div class="disposal-reason">
                                            {% if item.disposal_reason %}
                                                <strong>Reason:</strong> {{ item.disposal_reason }}
                                            {% else %}
                                                <span class="text-muted-small">No reason provided</span>
                                            {% endif %}
                                            {% if item.disposed_by_admin %}
                                                <br><small class="text-muted-small">By: {{ item.disposed_by_admin.username }}</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted-small">—</span>
                                    {% endif %}
                                </td>

                                <!-- Actions -->
                                <td>
                                    <a href="{{ url_for('admin.edit_item', item_id=item.item_id) }}" class="btn-edit">
                                        <i class="fas fa-edit"></i>Edit
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-items">
                    <i class="fas fa-inbox"></i>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No items found</p>
                    <p style="font-size: 0.95rem;">No items match the current filters and your access scope.</p>
                </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}