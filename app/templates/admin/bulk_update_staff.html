{% extends "base.html" %}

{% block title %}Bulk Update Staff{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  :root{
    --dut-navy:#001F3F;--dut-maroon:#800000;--dut-light:#f8f9fa;
    --text-primary:#1a1a1a;--text-secondary:#555;--border-color:#e8eef5;
    --success:#198754;--danger:#dc3545;--warning:#ffc107;--info:#0dcaf0;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:linear-gradient(135deg,#f5f7fa 0%,#e9ecf1 100%);
    min-height:100vh;color:var(--text-primary);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  }
  .container-fluid{max-width:1200px;padding:1.5rem;}

  .header-section{background:#fff;padding:1.75rem;border-radius:12px;
    box-shadow:0 2px 8px rgba(0,31,63,.06);margin-bottom:2rem;
    border-top:4px solid var(--dut-navy);}
  .header-content h1{font-size:2rem;font-weight:700;color:var(--dut-navy);
    display:flex;align-items:center;gap:.75rem;margin:0;}
  .header-content p{color:var(--text-secondary);margin-top:.5rem;font-size:.95rem;}

  .btn{padding:.75rem 1.25rem;border:none;border-radius:8px;
    font-weight:600;cursor:pointer;transition:all .3s ease;
    text-decoration:none;display:inline-flex;align-items:center;
    gap:.5rem;font-size:.9rem;}
  .btn-primary{background:var(--dut-maroon);color:#fff;}
  .btn-primary:hover{background:#6a0000;transform:translateY(-2px);}
  .btn-secondary{background:#fff;color:var(--dut-navy);border:2px solid var(--dut-navy);}
  .btn-secondary:hover{background:var(--dut-navy);color:#fff;}

  .alert{border-radius:8px;padding:1rem 1.25rem;margin-bottom:1.5rem;
    display:flex;align-items:center;gap:.75rem;font-size:.9rem;}
  .alert-success{background:#d1e7dd;color:#0f5132;}
  .alert-danger{background:#f8d7da;color:#842029;}
  .alert-warning{background:#fff3cd;color:#664d03;}
  .alert-info{background:#cfe2ff;color:#084298;}
  .btn-close{background:none;border:none;font-size:1.25rem;
    cursor:pointer;opacity:.6;margin-left:auto;}
  .btn-close:hover{opacity:1;}

  .card{background:#fff;border-radius:12px;border:1px solid var(--border-color);
    box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:1.5rem;}
  .card-header{
    background:linear-gradient(135deg,var(--dut-navy) 0%,#000d2e 100%);
    color:#fff;padding:1rem 1.5rem;display:flex;align-items:center;gap:.75rem;
  }
  .card-header h5{margin:0;font-size:1.1rem;font-weight:700;}
  .card-body{padding:1.5rem;}

  .form-label{font-weight:600;color:var(--dut-navy);font-size:.85rem;
    margin-bottom:.35rem;display:block;}
  .form-control, .form-select{
    border:2px solid var(--border-color);border-radius:8px;
    padding:.5rem .75rem;font-size:.9rem;width:100%;
    transition:border .2s ease;
  }
  .form-control:focus, .form-select:focus{
    border-color:var(--dut-navy);outline:none;
    box-shadow:0 0 0 3px rgba(0,31,63,.1);
  }

  .mb-3{margin-bottom:1rem;}
  .mb-4{margin-bottom:1.5rem;}
  .d-flex{display:flex;}
  .gap-2{gap:.5rem;}

  /* FILTER SECTION */
  .filter-section .card-header{
    background:linear-gradient(135deg,var(--dut-navy),#001a33);
  }

  /* Room table styling */
  .table-wrapper{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:.75rem 1rem;text-align:left;font-size:.9rem;
    border-bottom:1px solid var(--border-color);}
  thead th{
    background:#f8f9fa;color:var(--dut-navy);font-weight:700;
    text-transform:uppercase;font-size:.75rem;letter-spacing:.5px;
  }
  tbody tr{transition:background .2s ease;}
  tbody tr:hover{background:#f8f9fa;}
  
  .room-name{font-weight:600;color:var(--dut-navy);}
  .campus-badge{
    display:inline-block;background:#e0e7ff;color:#3730a3;
    padding:.35rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;
  }

  /* Checkbox styling */
  .checkbox-cell{text-align:center;width:50px;}
  .form-check-input{
    width:1.25rem;height:1.25rem;cursor:pointer;
  }

  /* Select all controls */
  .select-controls{
    display:flex;gap:1rem;align-items:center;padding:.75rem;
    background:#f8f9fa;border-radius:8px;margin-bottom:1rem;
  }
  .select-controls .btn{padding:.5rem 1rem;font-size:.85rem;}

  .no-items{
    text-align:center;padding:3rem;color:var(--text-secondary);
    background:#fafafa;border:2px dashed var(--border-color);
    border-radius:12px;margin:2rem 0;
  }
  .no-items i{font-size:3.5rem;color:#ccc;margin-bottom:1rem;}

  /* Staff info display */
  .staff-info{
    display:flex;flex-direction:column;gap:.25rem;
  }
  .staff-info .current{
    color:var(--text-secondary);font-size:.8rem;
  }

  /* Search info text */
  .search-info{
    font-size:.85rem;color:var(--text-secondary);margin-top:.25rem;
    display:block;
  }

  @media (max-width:768px){
    .container-fluid{padding:1rem;}
    .header-section{padding:1.25rem;}
    .header-content h1{font-size:1.6rem;}
    .card-body{padding:1.25rem;}
    .select-controls{flex-wrap:wrap;}
    th,td{padding:.6rem .75rem;font-size:.85rem;}
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="header-section">
    <div class="header-content">
      <h1><i class="fas fa-users-cog"></i>Bulk Update Staff</h1>
      <p>Search, filter, and update staff details for multiple rooms at once.</p>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">
          <i class="fas fa-{% if category == 'danger' %}exclamation-circle
                          {% elif category == 'success' %}check-circle
                          {% else %}info-circle{% endif %}"></i>
          <span>{{ message }}</span>
          <button type="button" class="btn-close" data-bs-dismiss="alert">×</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- FILTER BAR -->
  <div class="filter-section card mb-4">
    <div class="card-header">
      <h6 class="mb-0"><i class="fas fa-filter"></i> Search & Filter Rooms</h6>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('admin.bulk_update_staff') }}" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <input type="text" name="q" class="form-control" 
                 placeholder="Room name, staff name, or staff number..." 
                 value="{{ request.args.get('q', '') }}">
          <small class="search-info">
            Searches in room name, staff name, and staff number
          </small>
        </div>

        <div class="col-md-3">
          <label class="form-label">Campus</label>
          <select name="campus_id" class="form-select">
            <option value="">All Campuses</option>
            {% set unique_campuses = [] %}
            {% for room in rooms %}
              {% if room.campus.campus_id not in unique_campuses %}
                <option value="{{ room.campus.campus_id }}" 
                        {{ 'selected' if request.args.get('campus_id') == room.campus.campus_id|string else '' }}>
                  {{ room.campus.name }}
                </option>
                {% set _ = unique_campuses.append(room.campus.campus_id) %}
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Staff Status</label>
          <select name="staff_status" class="form-select">
            <option value="">All Rooms</option>
            <option value="assigned" {{ 'selected' if request.args.get('staff_status') == 'assigned' else '' }}>
              Has Staff Assigned
            </option>
            <option value="unassigned" {{ 'selected' if request.args.get('staff_status') == 'unassigned' else '' }}>
              No Staff Assigned
            </option>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search"></i> Apply
          </button>
        </div>
      </form>
      <div class="mt-3">
        <a href="{{ url_for('admin.bulk_update_staff') }}" class="btn btn-secondary">
          <i class="fas fa-times"></i> Clear Filters
        </a>
      </div>
    </div>
  </div>

  <form method="POST">
    <!-- Staff Information Card -->
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-clipboard-list"></i>New Staff Information</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="staff_name">
              <i class="fas fa-user"></i> Staff Name
            </label>
            <input type="text" class="form-control" id="staff_name" 
                   name="staff_name" placeholder="Enter staff name">
            <small style="color:var(--text-secondary);font-size:.8rem;margin-top:.25rem;display:block;">
              Leave blank to keep existing staff names
            </small>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="staff_number">
              <i class="fas fa-id-card"></i> Staff Number
            </label>
            <input type="text" class="form-control" id="staff_number" 
                   name="staff_number" placeholder="Enter 8-digit staff number" 
                   maxlength="8" pattern="[0-9]{8}">
            <small style="color:var(--text-secondary);font-size:.8rem;margin-top:.25rem;display:block;">
              Leave blank to keep existing staff numbers
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Room Selection Card -->
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-door-open"></i> Select Rooms to Update</h5>
        {% if rooms %}
          <small style="color:#c8d6ff;font-size:.85rem;margin-top:.25rem;">
            Showing {{ rooms|length }} room(s)
          </small>
        {% endif %}
      </div>
      <div class="card-body">
        {% if rooms %}
          <div class="select-controls">
            <button type="button" class="btn btn-secondary" onclick="selectAll()">
              <i class="fas fa-check-square"></i> Select All
            </button>
            <button type="button" class="btn btn-secondary" onclick="deselectAll()">
              <i class="fas fa-square"></i> Deselect All
            </button>
            <button type="button" class="btn btn-secondary" onclick="selectFiltered()">
              <i class="fas fa-filter"></i> Select Visible
            </button>
            <span style="color:var(--text-secondary);font-size:.9rem;margin-left:auto;">
              <strong id="selectedCount">0</strong> room(s) selected
            </span>
          </div>

          <div class="table-wrapper">
            <table id="roomsTable">
              <thead>
                <tr>
                  <th class="checkbox-cell">
                    <input type="checkbox" id="selectAllCheckbox" 
                           onchange="toggleAll(this)" title="Select/Deselect All">
                  </th>
                  <th>Room Name</th>
                  <th>Campus</th>
                  <th>Current Staff Name</th>
                  <th>Current Staff Number</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                {% for room in rooms %}
                <tr class="room-row" 
                    data-room-name="{{ room.name|lower }}"
                    data-campus-id="{{ room.campus.campus_id }}"
                    data-staff-name="{{ room.staff_name|lower if room.staff_name else '' }}"
                    data-staff-number="{{ room.staff_number if room.staff_number else '' }}"
                    data-has-staff="{{ 'yes' if room.staff_name or room.staff_number else 'no' }}">
                  <td class="checkbox-cell">
                    <input class="form-check-input room-checkbox" type="checkbox" 
                           value="{{ room.room_id }}" name="room_ids" 
                           id="room_{{ room.room_id }}"
                           onchange="updateCount()">
                  </td>
                  <td class="room-name">{{ room.name }}</td>
                  <td><span class="campus-badge">{{ room.campus.name }}</span></td>
                  <td>
                    <div class="staff-info">
                      <span>{{ room.staff_name or '—' }}</span>
                    </div>
                  </td>
                  <td>{{ room.staff_number or '—' }}</td>
                  <td>
                    {{ room.description[:40] + '...' if room.description and room.description|length > 40 else room.description or '—' }}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="no-items">
            <i class="fas fa-inbox"></i>
            <p><strong>No rooms found</strong></p>
            <p>Try adjusting your search filters or add new rooms.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Action Buttons -->
    {% if rooms %}
    <div class="card">
      <div class="card-body">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Update Selected Rooms
          </button>
          <a href="{{ url_for('admin.list_rooms') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Rooms
          </a>
        </div>
      </div>
    </div>
    {% endif %}
  </form>
</div>

<script>
  function selectAll() {
    document.querySelectorAll('.room-checkbox').forEach(checkbox => {
      checkbox.checked = true;
    });
    document.getElementById('selectAllCheckbox').checked = true;
    updateCount();
  }

  function deselectAll() {
    document.querySelectorAll('.room-checkbox').forEach(checkbox => {
      checkbox.checked = false;
    });
    document.getElementById('selectAllCheckbox').checked = false;
    updateCount();
  }

  function selectFiltered() {
    document.querySelectorAll('.room-row').forEach(row => {
      if (row.style.display !== 'none') {
        const checkbox = row.querySelector('.room-checkbox');
        if (checkbox) checkbox.checked = true;
      }
    });
    updateCount();
  }

  function toggleAll(checkbox) {
    document.querySelectorAll('.room-checkbox').forEach(cb => {
      cb.checked = checkbox.checked;
    });
    updateCount();
  }

  function updateCount() {
    const count = document.querySelectorAll('.room-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
    
    const allCheckboxes = document.querySelectorAll('.room-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
    document.getElementById('selectAllCheckbox').checked = allChecked && allCheckboxes.length > 0;
  }

  // Enhanced client-side filtering to include staff name and number
  function filterTable() {
    const searchTerm = document.querySelector('input[name="q"]')?.value.toLowerCase() || '';
    const campusFilter = document.querySelector('select[name="campus_id"]')?.value || '';
    const staffFilter = document.querySelector('select[name="staff_status"]')?.value || '';

    document.querySelectorAll('.room-row').forEach(row => {
      const roomName = row.dataset.roomName || '';
      const campusId = row.dataset.campusId || '';
      const staffName = row.dataset.staffName || '';
      const staffNumber = row.dataset.staffNumber || '';
      const hasStaff = row.dataset.hasStaff || '';

      let showRow = true;

      // Search filter - now searches multiple fields
      if (searchTerm) {
        const matchesRoomName = roomName.includes(searchTerm);
        const matchesStaffName = staffName.includes(searchTerm);
        const matchesStaffNumber = staffNumber.includes(searchTerm);
        
        if (!(matchesRoomName || matchesStaffName || matchesStaffNumber)) {
          showRow = false;
        }
      }

      // Campus filter
      if (campusFilter && campusId !== campusFilter) {
        showRow = false;
      }

      // Staff status filter
      if (staffFilter === 'assigned' && hasStaff === 'no') {
        showRow = false;
      } else if (staffFilter === 'unassigned' && hasStaff === 'yes') {
        showRow = false;
      }

      row.style.display = showRow ? '' : 'none';
    });

    updateCount();
  }

  // Initialize count on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateCount();
    
    // Add live filtering
    const searchInput = document.querySelector('input[name="q"]');
    const campusSelect = document.querySelector('select[name="campus_id"]');
    const staffSelect = document.querySelector('select[name="staff_status"]');
    
    if (searchInput) searchInput.addEventListener('input', filterTable);
    if (campusSelect) campusSelect.addEventListener('change', filterTable);
    if (staffSelect) staffSelect.addEventListener('change', filterTable);
    
    // Initial filter in case there are query parameters
    filterTable();
  });
</script>
{% endblock %}