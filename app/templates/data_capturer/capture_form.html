{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 1rem;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
    }

    .header {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border-top: 4px solid #001F3F;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 31, 63, 0.06);
    }

    .header h1 {
        color: #001F3F;
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .header p {
        color: #555;
        font-size: 0.9rem;
    }

    .room-badge {
        background: linear-gradient(135deg, #001F3F 0%, #000d2e 100%);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        display: inline-block;
        margin-top: 0.75rem;
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card-header {
        background: linear-gradient(135deg, #001F3F 0%, #000d2e 100%);
        color: white;
        padding: 1.5rem;
        border: none;
    }

    .card-header h5 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-body {
        padding: 1.75rem;
    }

    .form-section {
        margin-bottom: 1.75rem;
    }

    .form-section:last-child {
        margin-bottom: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-weight: 600;
        color: #001F3F;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .required {
        color: #dc3545;
    }

    .form-control, .form-select {
        border: 2px solid #e8eef5;
        border-radius: 8px;
        padding: 0.875rem;
        font-size: 1rem;
        color: #1a1a1a;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    .form-control:focus, .form-select:focus {
        border-color: #001F3F;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 31, 63, 0.1);
    }

    .form-control::placeholder {
        color: #999;
    }

    .scanner-hint {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .conditional-input {
        display: none;
        margin-top: 0.75rem;
    }

    .conditional-input.show {
        display: flex;
        flex-direction: column;
    }

    .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 2rem;
    }

    .button-group.full {
        grid-template-columns: 1fr;
    }

    .btn {
        padding: 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
        width: 100%; /* Default full width */
    }
    
    /* Custom style to make back button fit its content */
    .btn-back-to-manage {
        width: auto;
    }

    .btn-primary {
        background: #800000;
        color: white;
    }

    .btn-primary:hover {
        background: #6a0000;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(128, 0, 0, 0.2);
    }

    .btn-secondary {
        background: white;
        color: #001F3F;
        border: 2px solid #001F3F;
    }

    .btn-secondary:hover {
        background: #001F3F;
        color: white;
    }

    .info-box {
        background: #f0f4fa;
        border-left: 4px solid #001F3F;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        color: #333;
    }

    .info-box i {
        color: #001F3F;
        margin-right: 0.5rem;
    }

    .divider {
        height: 1px;
        background: #e8eef5;
        margin: 2rem 0;
    }

    .status-chip {
        display: inline-block;
        background: #e8f5e9;
        color: #2e7d32;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 0.75rem;
    }

    .status-chip.error {
        background: #ffebee;
        color: #c62828;
    }

    @media (max-width: 768px) {
        body {
            padding: 0.75rem;
        }

        .header {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 1.4rem;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.25rem;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        .button-group {
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.85rem;
            font-size: 0.9rem;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.2rem;
        }

        .card-body {
            padding: 1rem;
        }

        .btn {
            padding: 0.8rem;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block title %}Asset Capture - {{ room.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1><i class="fas fa-barcode"></i>Asset Capture</h1>
        <p>Capture item details for your inventory</p>
        <div class="room-badge">
            <i class="fas fa-door-closed"></i>{{ room.campus.name }} - {{ room.name }} (ID: {{ room_id }})
        </div>

        <a href="{{ url_for('capturer.manage_room_items', room_id=room_id) }}" class="btn btn-secondary mt-3 btn-back-to-manage">
            <i class="fas fa-arrow-left"></i> Back to Manage Room Items
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i>Asset Information</h5>
        </div>
        <div class="card-body">
            <form id="assetForm">
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>Use a barcode scanner or enter manually. Scanner input auto-advances to the next field.
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-barcode"></i>Asset Number <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="assetNumber" 
                            placeholder="Scan or enter asset number"
                            autofocus
                        >
                        <span class="scanner-hint"><i class="fas fa-lightbulb"></i>Tab or Enter advances to next field</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag"></i>Serial Number
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="serialNumber" 
                            placeholder="Scan or enter serial number"
                        >
                        <span class="scanner-hint"><i class="fas fa-lightbulb"></i>Optional if not on device</span>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-box"></i>Item Type <span class="required">*</span>
                        </label>
                        <select class="form-select" id="itemTypeSelect">
                            <option value="">-- Select Item Type --</option>
                            <option value="86 inch Monitor">86 inch Monitor</option>
                            <option value="75 inch Monitor">75 inch Monitor</option>
                            <option value="Workstation">Workstation</option>
                            <option value="Webcam Screen">Webcam Screen</option>
                            <option value="Headphone">Headphone</option>
                            <option value="Router">Router</option>
                            <option value="Humanoid">Humanoid</option>
                            <option value="Mini Robot">Mini Robot</option>
                            <option value="Robotic arm / hand">Robotic arm / hand</option>
                            <option value="VR">VR</option>
                            <option value="Xbox">Xbox</option>
                            <option value="Docking station">Docking station</option>
                            <option value="BOOK">BOOK</option>
                            <option value="POWER Backup">POWER Backup</option>
                            <option value="Aircon">Aircon</option>
                            <option value="Chair">Chair</option>
                            <option value="Desk">Desk</option>
                            <option value="Table">Table</option>
                            <option value="OTHER">OTHER - Please specify</option>
                        </select>
                    </div>
                    <div class="conditional-input" id="itemTypeOther">
                        <label class="form-label">Specify Item Type</label>
                        <input type="text" class="form-control" id="itemTypeOtherText" placeholder="Enter custom item type">
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i>Description
                        </label>
                        <textarea 
                            class="form-control" 
                            id="description" 
                            rows="3" 
                            placeholder="Enter additional details (required if Item Type is 'OTHER')"
                        ></textarea>
                        <span class="scanner-hint"><i class="fas fa-lightbulb"></i>Useful for capturing details not in dropdown</span>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-palette"></i>Color
                        </label>
                        <select class="form-select" id="colorSelect">
                            <option value="">-- Select Color --</option>
                            <option value="Black">Black</option>
                            <option value="White">White</option>
                            <option value="Silver">Silver</option>
                            <option value="Grey">Grey</option>
                            <option value="Red">Red</option>
                            <option value="Blue">Blue</option>
                            <option value="Green">Green</option>
                            <option value="Brown">Brown</option>
                            <option value="Orange">Orange</option>
                            <option value="Yellow">Yellow</option>
                            <option value="Gold">Gold</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-industry"></i>Brand
                        </label>
                        <select class="form-select" id="brandSelect">
                            <option value="">-- Select Brand --</option>
                            <option value="Apple">Apple</option>
                            <option value="Dell">Dell</option>
                            <option value="HP">HP</option>
                            <option value="Lenovo">Lenovo</option>
                            <option value="Samsung">Samsung</option>
                            <option value="Sony">Sony</option>
                            <option value="Canon">Canon</option>
                            <option value="Hikvision">Hikvision</option>
                            <option value="Sunsynk">Sunsynk</option>
                            <option value="Flexo">Flexo</option>
                            <option value="OTHER">OTHER - Please specify</option>
                        </select>
                    </div>
                </div>

                <div class="conditional-input" id="brandOther">
                    <label class="form-label">Specify Brand</label>
                    <input type="text" class="form-control" id="brandOtherText" placeholder="Enter custom brand name">
                </div>

                <div class="divider"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-check"></i>Capture Date (Today) <span class="required">*</span>
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="captureDate"
                            readonly
                        >
                        <span class="scanner-hint"><i class="fas fa-lightbulb"></i>Auto-set to today (read-only)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i>Allocation Date
                        </label>
                        <input 
                            type="date" 
                            class="form-control" 
                            id="allocationDate"
                            placeholder="When was this item allocated?"
                        >
                        <span class="scanner-hint"><i class="fas fa-lightbulb"></i>Optional - when item was originally issued</span>
                    </div>
                </div>

                <div class="button-group full">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i>Capture Item
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-redo"></i>Clear Form
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="successMessage" style="display: none;">
                <div class="status-chip"><i class="fas fa-check"></i> Asset captured successfully!</div>
            </div>
            <div id="errorMessage" style="display: none;">
                <div class="status-chip error">
                    <i class="fas fa-exclamation-circle"></i> <span id="errorText">Error</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Set today's date as default
    document.getElementById('captureDate').valueAsDate = new Date();

    // Asset Number auto-advance on Tab or Enter
    document.getElementById('assetNumber').addEventListener('keydown', (e) => {
        if (e.key === 'Tab' || e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('serialNumber').focus();
        }
    });

    // Item Type conditional input
    document.getElementById('itemTypeSelect').addEventListener('change', (e) => {
        const conditional = document.getElementById('itemTypeOther');
        if (e.target.value === 'OTHER') {
            conditional.classList.add('show');
        } else {
            conditional.classList.remove('show');
            document.getElementById('itemTypeOtherText').value = '';
        }
    });

    // Brand conditional input
    document.getElementById('brandSelect').addEventListener('change', (e) => {
        const conditional = document.getElementById('brandOther');
        if (e.target.value === 'OTHER') {
            conditional.classList.add('show');
        } else {
            conditional.classList.remove('show');
            document.getElementById('brandOtherText').value = '';
        }
    });

    // Form submission
    document.getElementById('assetForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const assetNumber = document.getElementById('assetNumber').value.trim();
        const itemType = document.getElementById('itemTypeSelect').value;
        const captureDate = document.getElementById('captureDate').value;

        // Get item type value (custom if OTHER)
        const finalItemType = itemType === 'OTHER' 
            ? document.getElementById('itemTypeOtherText').value.trim() 
            : itemType;

        // Get brand value (custom if OTHER)
        const brand = document.getElementById('brandSelect').value;
        const finalBrand = brand === 'OTHER' 
            ? document.getElementById('brandOtherText').value.trim() 
            : brand;

        // Validation
        if (!assetNumber || !itemType || !captureDate) {
            showError('Please fill all required fields');
            return;
        }

        if (itemType === 'OTHER' && !finalItemType) {
            showError('Please specify the custom item type');
            return;
        }

        if (brand === 'OTHER' && !finalBrand) {
            showError('Please specify the custom brand');
            return;
        }

        // Prepare form data
        const formData = new FormData();
        formData.append('assetNumber', assetNumber);
        formData.append('serialNumber', document.getElementById('serialNumber').value.trim());
        formData.append('itemType', finalItemType);
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('color', document.getElementById('colorSelect').value);
        formData.append('brand', finalBrand);
        formData.append('captureDate', captureDate);
        formData.append('allocationDate', document.getElementById('allocationDate').value);


        try {
            // Submit to the same URL (Flask will handle POST)
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });

            // Assuming your Flask route returns JSON for AJAX/Fetch submissions
            const result = await response.json();

            if (response.ok) {
                showSuccess();
                // Reset form fields after successful capture
                document.getElementById('assetForm').reset();
                // Re-set the capture date and autofocus
                document.getElementById('captureDate').valueAsDate = new Date();
                setTimeout(() => {
                    document.getElementById('assetNumber').focus();
                }, 500);
            } else {
                showError(result.message || 'Error saving item');
            }
        } catch (error) {
            showError('Network error: ' + error.message);
            console.error('Error:', error);
        }
    });

    function showSuccess() {
        const successMsg = document.getElementById('successMessage');
        const errorMsg = document.getElementById('errorMessage');
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 4000);
    }

    function showError(message) {
        const errorMsg = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorMsg.style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
    }
</script>
{% endblock %}