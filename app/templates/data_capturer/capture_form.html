{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
    /* (Your existing beautiful CSS – unchanged) */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 1rem;
    }

    .container { max-width: 900px; margin: 0 auto; }

    .header {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border-top: 4px solid #001F3F;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,31,63,0.06);
    }
    .header h1 { color: #001F3F; font-size: 1.75rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
    .header p { color: #555; font-size: 0.9rem; }
    .room-badge { background: linear-gradient(135deg, #001F3F 0%, #000d2e 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; margin-top: 0.75rem; }

    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; margin-bottom: 1.5rem; }
    .card-header { background: linear-gradient(135deg, #001F3F 0%, #000d2e 100%); color: white; padding: 1.5rem; }
    .card-header h5 { margin: 0; font-size: 1.15rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; }
    .card-body { padding: 1.75rem; }

    .form-section { margin-bottom: 1.75rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .form-row.full { grid-template-columns: 1fr; }
    .form-group { display: flex; flex-direction: column; position: relative; }
    .form-label { font-weight: 600; color: #001F3F; margin-bottom: 0.75rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
    .required { color: #dc3545; }

    .input-with-button { display: flex; gap: 0.5rem; align-items: stretch; }
    .input-with-button input { flex: 1; }
    .scan-btn { padding: 0.875rem 1rem; background: #001F3F; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; white-space: nowrap; }
    .scan-btn:hover { background: #003366; transform: translateY(-2px); }

    .form-control, .form-select {
        border: 2px solid #e8eef5;
        border-radius: 8px;
        padding: 0.875rem;
        font-size: 1rem;
        color: #1a1a1a;
        transition: all 0.3s ease;
        background: white;
    }
    .form-control:focus, .form-select:focus { border-color: #001F3F; outline: none; box-shadow: 0 0 0 3px rgba(0,31,63,0.1); }

    /* Autocomplete styles (unchanged) */
    .autocomplete-wrapper { position: relative; }
    .autocomplete-dropdown {
        position: absolute;
        top: 100%; left: 0; right: 0;
        background: white;
        border: 2px solid #001F3F;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 240px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0,31,63,0.15);
        display: none;
    }
    .autocomplete-dropdown.show { display: block; }
    .autocomplete-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .autocomplete-item:hover, .autocomplete-item.highlighted { background: #001F3F; color: white; }
    .autocomplete-empty { padding: 1rem; text-align: center; color: #666; font-style: italic; }

    .scanner-hint { font-size: 0.8rem; color: #666; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }
    .scanner-hint.tab-hint { color: #001F3F; font-weight: 600; }

    .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; }
    .button-group.full { grid-template-columns: 1fr; }
    .btn { padding: 1rem; border-radius: 8px; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; }
    .btn-primary { background: #800000; color: white; }
    .btn-primary:hover { background: #6a0000; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(128,0,0,0.2); }
    .btn-secondary { background: white; color: #001F3F; border: 2px solid #001F3F; }
    .btn-secondary:hover { background: #001F3F; color: white; }

    .info-box { background: #f0f4fa; border-left: 4px solid #001F3F; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; color: #333; }
    .info-box i { color: #001F3F; margin-right: 0.5rem; }
    .divider { height: 1px; background: #e8eef5; margin: 2rem 0; }
    .status-chip { display: inline-block; background: #e8f5e9; color: #2e7d32; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-top: 0.75rem; }
    .status-chip.error { background: #ffebee; color: #c62828; }

    .scanner-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; align-items: center; justify-content: center; padding: 1rem; }
    .scanner-modal.active { display: flex; }
    .scanner-container { background: white; border-radius: 12px; padding: 1.5rem; max-width: 500px; width: 100%; }
    .scanner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .scanner-header h3 { color: #001F3F; margin: 0; }
    .close-scanner { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; }
    #reader { border-radius: 8px; overflow: hidden; border: 2px solid #001F3F; }
    .scan-result { margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 8px; color: #2e7d32; font-weight: 600; display: none; }

    @media (max-width: 768px) {
        .form-row { grid-template-columns: 1fr; }
        .button-group { gap: 0.75rem; margin-top: 1.5rem; }
    }
</style>
{% endblock %}

{% block title %}Asset Capture - {{ room.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1><i class="fas fa-barcode"></i>Asset Capture</h1>
        <p>Capture item details for your inventory</p>
        <div class="room-badge">
            <i class="fas fa-door-closed"></i>{{ room.campus.name }} - {{ room.name }}
        </div>

        <div class="mt-3 d-flex gap-2 flex-wrap">
            <a href="{{ url_for('capturer.manage_room_items', room_id=room_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Room
            </a>
            <a href="{{ url_for('capturer.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-tachometer-alt"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i>Asset Information</h5>
        </div>
        <div class="card-body">
            <form id="assetForm">
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>Use barcode scanner, phone camera, or type manually. Start typing in Item Type, Brand, or Color for instant suggestions.
                </div>

                <!-- Asset & Serial -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-barcode"></i>Asset Number <span class="required">*</span></label>
                        <div class="input-with-button">
                            <input type="text" class="form-control" id="assetNumber" name="assetNumber" placeholder="Scan or enter" autofocus required>
                            <button type="button" class="scan-btn" onclick="openScanner('asset')">
                                <i class="fas fa-camera"></i> <span class="d-none d-sm-inline">Scan</span>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-hashtag"></i>Serial Number</label>
                        <div class="input-with-button">
                            <input type="text" class="form-control" id="serialNumber" name="serialNumber" placeholder="Optional">
                            <button type="button" class="scan-btn" onclick="openScanner('serial')">
                                <i class="fas fa-camera"></i> <span class="d-none d-sm-inline">Scan</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Item Type -->
                <div class="form-section">
                    <div class="form-group autocomplete-wrapper">
                        <label class="form-label"><i class="fas fa-box"></i>Item Type <span class="required">*</span></label>
                        <input type="text" class="form-control" id="itemType" name="itemType" placeholder="Start typing... (e.g., Laptop, Chair)" autocomplete="off" required>
                        <div class="autocomplete-dropdown" id="itemType-dropdown"></div>
                        <span class="scanner-hint tab-hint"><i class="fas fa-search"></i>Type to search • ↑↓ to navigate • Enter to select</span>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-align-left"></i>Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter additional details"></textarea>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-tags"></i>Item Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="TEACHING_LEARNING" selected>Teaching & Learning</option>
                            <option value="PROJECTS_RESEARCH">Projects/Research</option>
                            <option value="COMMERCIAL">Commercial</option>
                        </select>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Color & Brand -->
                <div class="form-row">
                    <div class="form-group autocomplete-wrapper">
                        <label class="form-label"><i class="fas fa-palette"></i>Color</label>
                        <input type="text" class="form-control" id="color" name="color" placeholder="e.g., Black, Silver" autocomplete="off">
                        <div class="autocomplete-dropdown" id="color-dropdown"></div>
                    </div>
                    <div class="form-group autocomplete-wrapper">
                        <label class="form-label"><i class="fas fa-industry"></i>Brand</label>
                        <input type="text" class="form-control" id="brand" name="brand" placeholder="e.g., Dell, HP" autocomplete="off">
                        <div class="autocomplete-dropdown" id="brand-dropdown"></div>
                    </div>
                </div>

                <div class="form-row full" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-database"></i>Capacity / Specifications</label>
                        <input type="text" class="form-control" id="capacity" name="capacity" placeholder="e.g., 1TB SSD, 16GB RAM">
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar-plus"></i>Procurement Date <span class="required">*</span></label>
                        <input type="date" class="form-control" id="procuredDate" name="procuredDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar-alt"></i>Allocation Date</label>
                        <input type="date" class="form-control" id="allocationDate" name="allocationDate">
                    </div>
                </div>

                <div class="button-group full">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i>Capture Item
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-redo"></i>Clear Form
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="successMessage" style="display: none;">
                <div class="status-chip"><i class="fas fa-check"></i> Asset captured successfully!</div>
            </div>
            <div id="errorMessage" style="display: none;">
                <div class="status-chip error"><i class="fas fa-exclamation-circle"></i> <span id="errorText"></span></div>
            </div>
        </div>
    </div>
</div>

<!-- Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
    <div class="scanner-container">
        <div class="scanner-header">
            <h3><i class="fas fa-camera"></i> Scan Barcode</h3>
            <button class="close-scanner" onclick="closeScanner()"><i class="fas fa-times"></i> Close</button>
        </div>
        <div id="reader"></div>
        <div class="scan-result" id="scanResult"></div>
    </div>
</div>

<script>
    // === AUTOCOMPLETE CLASS (unchanged) ===
    class SearchAutocomplete {
        constructor(inputId, dropdownId, suggestions) {
            this.input = document.getElementById(inputId);
            this.dropdown = document.getElementById(dropdownId);
            this.suggestions = suggestions.map(s => s.trim()).filter(Boolean);
            this.filtered = [];
            this.selectedIndex = -1;

            this.input.addEventListener('input', () => this.filter());
            this.input.addEventListener('keydown', e => this.handleKeydown(e));
            this.input.addEventListener('focus', () => this.filter());
            this.input.addEventListener('blur', () => setTimeout(() => this.dropdown.classList.remove('show'), 200));

            document.addEventListener('click', e => {
                if (!this.input.contains(e.target) && !this.dropdown.contains(e.target)) {
                    this.dropdown.classList.remove('show');
                }
            });
        }

        filter() {
            const query = this.input.value.trim().toLowerCase();
            this.selectedIndex = -1;
            if (!query) { this.dropdown.classList.remove('show'); return; }

            this.filtered = this.suggestions
                .filter(item => item.toLowerCase().includes(query))
                .slice(0, 10);

            this.render();
            this.dropdown.classList.toggle('show', this.filtered.length > 0);
        }

        render() {
            if (!this.filtered.length) {
                this.dropdown.innerHTML = '<div class="autocomplete-empty">No items found</div>';
                return;
            }
            this.dropdown.innerHTML = this.filtered.map((item, i) => `
                <div class="autocomplete-item" data-index="${i}">
                    ${this.highlightMatch(item, this.input.value)}
                </div>
            `).join('');

            this.dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    this.input.value = this.filtered[item.dataset.index];
                    this.dropdown.classList.remove('show');
                    this.input.focus();
                });
            });
        }

        highlightMatch(text, query) {
            if (!query.trim()) return text;
            const regex = new RegExp(`(${query.trim()})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        handleKeydown(e) {
            if (!this.dropdown.classList.contains('show')) return;
            if (e.key === 'ArrowDown') { e.preventDefault(); this.selectedIndex = Math.min(this.selectedIndex + 1, this.filtered.length - 1); this.highlight(); }
            else if (e.key === 'ArrowUp') { e.preventDefault(); this.selectedIndex = Math.max(this.selectedIndex - 1, -1); this.highlight(); }
            else if (e.key === 'Enter' && this.selectedIndex >= 0) { e.preventDefault(); this.input.value = this.filtered[this.selectedIndex]; this.dropdown.classList.remove('show'); }
            else if (e.key === 'Escape') this.dropdown.classList.remove('show');
        }

        highlight() {
            this.dropdown.querySelectorAll('.autocomplete-item').forEach((el, i) => {
                el.classList.toggle('highlighted', i === this.selectedIndex);
            });
        }
    }

    // === SCANNER & FORM LOGIC ===
    let html5QrCode = null;
    let currentScanTarget = null;

    function openScanner(target) {
        currentScanTarget = target;
        document.getElementById('scannerModal').classList.add('active');
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                if (currentScanTarget === 'asset') document.getElementById('assetNumber').value = decodedText;
                else if (currentScanTarget === 'serial') document.getElementById('serialNumber').value = decodedText;
                document.getElementById('scanResult').textContent = `Success: ${decodedText}`;
                document.getElementById('scanResult').style.display = 'block';
                setTimeout(closeScanner, 1500);
            },
            () => {}
        ).catch(err => { alert("Camera error: " + err); closeScanner(); });
    }

    function closeScanner() {
        document.getElementById('scannerModal').classList.remove('active');
        if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
        document.getElementById('scanResult').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const itemTypeSuggestions = {{ item_type_suggestions | tojson | safe }};
        const brandSuggestions   = {{ brand_suggestions   | tojson | safe }};
        const colorSuggestions   = {{ color_suggestions   | tojson | safe }};

        new SearchAutocomplete('itemType', 'itemType-dropdown', itemTypeSuggestions);
        new SearchAutocomplete('brand',    'brand-dropdown',    brandSuggestions);
        new SearchAutocomplete('color',    'color-dropdown',    colorSuggestions);

        // Quick tab navigation
        document.getElementById('assetNumber').addEventListener('keydown', e => e.key === 'Enter' && document.getElementById('serialNumber').focus());
        document.getElementById('serialNumber').addEventListener('keydown', e => e.key === 'Enter' && document.getElementById('itemType').focus());

        // Form submit via AJAX
        document.getElementById('assetForm').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const res = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    showSuccess();
                    e.target.reset();
                    setTimeout(() => document.getElementById('assetNumber').focus(), 100);
                } else {
                    showError(data.message || 'Failed to save item');
                }
            } catch (err) {
                showError('Network error – please try again');
            }
        });
    });

    function showSuccess() {
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        setTimeout(() => document.getElementById('successMessage').style.display = 'none', 4000);
    }

    function showError(msg) {
        document.getElementById('errorText').textContent = msg;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
    }
</script>
{% endblock %}