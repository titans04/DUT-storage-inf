{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  :root {
    --dut-navy: #001F3F;
    --dut-maroon: #800000;
    --border-color: #e8eef5;
    --warning: #ffc107;
  }

  body { background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  .container-fluid { max-width: 1400px; margin: 0 auto; padding: 1rem; }

  .header-section { background: white; padding: 1.75rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,31,63,0.06); margin-bottom: 2rem; border-top: 5px solid var(--dut-navy); }
  .header-top { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
  .header-content h1 { font-size: 2rem; font-weight: 700; color: var(--dut-navy); display: flex; align-items: center; gap: 0.75rem; margin: 0; }
  .room-info { background: linear-gradient(135deg, var(--dut-navy), #000d2e); color: white; padding: 1rem 1.5rem; border-radius: 8px; font-size: 1.1rem; }

  .btn {
    padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
    display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; text-decoration: none;
    transition: all 0.3s;
  }
  .btn-primary { background: var(--dut-maroon); color: white; }
  .btn-primary:hover { background: #6a0000; transform: translateY(-2px); }
  .btn-secondary { background: white; color: var(--dut-navy); border: 2px solid var(--dut-navy); }
  .btn-secondary:hover, .btn-secondary.active { background: var(--dut-navy); color: white; }

  .search-filter-bar {
    display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; padding: 1rem;
    background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 1.5rem;
  }
  #searchInput {
    flex: 1; min-width: 280px; padding: 0.75rem 1rem; border: 2px solid #e8eef5; border-radius: 8px; font-size: 1rem;
  }
  #searchInput:focus { outline: none; border-color: var(--dut-navy); }

  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
  .stat-card { background: white; padding: 1.75rem; border-radius: 10px; border-left: 4px solid var(--dut-navy); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  .stat-card.warning { border-left-color: var(--warning); }
  .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--dut-navy); }
  .stat-card.warning .stat-number { color: var(--warning); }

  .card { background: white; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; }
  .card-header { background: linear-gradient(135deg, var(--dut-navy), #000d2e); color: white; padding: 1.5rem; }
  .card-header h5 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }

  .table thead { background: var(--dut-navy); color: white; }
  .table thead th { padding: 1rem; font-weight: 600; }
  .table tbody tr:hover { background: #f8f9fa; }
  .table tbody td { padding: 1rem; vertical-align: middle; }

  .asset-tag { font-weight: 700; color: var(--dut-navy); font-family: 'Courier New', monospace; font-size: 1.05rem; }
  .badge { padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem; }
  .badge-active { background: #d1e7dd; color: #0f5132; }
  .badge-inactive { background: #e2e3e5; color: #41464b; }
  .badge-repair { background: #fff3cd; color: #664d03; }
  .badge-stolen { background: #f8d7da; color: #842029; }

  .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
  .btn-edit { background: #0dcaf0; color: white; }
  .btn-edit:hover { background: #0aa2c0; }
  .btn-move { background: #17a2b8; color: white; }

  .show-more-btn {
    display: block; margin: 2rem auto; padding: 0.8rem 2rem;
    background: var(--dut-navy); color: white; border: none; border-radius: 8px;
    font-weight: 600; cursor: pointer;
  }
  .show-more-btn:hover { background: #000d40000; }

  @media (max-width: 768px) {
    .search-filter-bar { flex-direction: column; align-items: stretch; }
    #searchInput { min-width: 100%; }
  }
</style>
{% endblock %}

{% block title %}{{ room.name }} - Manage Inventory{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="header-section">
    <div class="header-top">
      <div class="header-content">
        <h1>Manage Inventory</h1>
      </div>
      <div>
        <a href="{{ url_for('capturer.bulk_capture', room_id=room.room_id) }}" class="btn btn-primary">
          Capture New Item
        </a>
        <a href="{{ url_for('capturer.dashboard') }}" class="btn btn-secondary">
          Back to Dashboard
        </a>
      </div>
    </div>
    <div class="room-info">
      <strong>{{ room.campus.name }}</strong> → <strong>{{ room.name }}</strong>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Items</div>
      <div class="stat-number">{{ total_items }}</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">Needs Repair</div>
      <div class="stat-number">{{ repair_items }}</div>
    </div>
  </div>

  <!-- Search + Filters + Table -->
  <div class="card">
    <div class="card-header">
      <h5>Room Inventory ({{ items | length }})</h5>
    </div>
    <div class="card-body">

      <div class="search-filter-bar">
        <input type="text" id="searchInput" placeholder="Search anything..." autocomplete="off">
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <button class="btn btn-secondary active" data-status="">All</button>
          <button class="btn btn-secondary" data-status="ACTIVE">Active</button>
          <button class="btn btn-secondary" data-status="NEEDS_REPAIR">Repair</button>
          <button class="btn btn-secondary" data-status="INACTIVE">Inactive</button>
          <button class="btn btn-secondary" data-status="STOLEN">Stolen</button>
        </div>
      </div>

      <table class="table" id="itemsTable">
        <thead>
          <tr>
            <th>Asset Number</th>
            <th>Item Type</th>
            <th>Brand</th>
            <th>Color</th>
            <th>Description</th>
            <th>Status</th>
            <th>Captured</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr data-status="{{ item.status.name }}" class="table-row">
            <td class="asset-tag">{{ item.asset_number }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.brand or '—' }}</td>
            <td>{{ item.color or '—' }}</td>
            <td title="{{ item.description or '' }}">
              {{ (item.description or '')[:35] }}{% if (item.description or '')|length > 35 %}...{% endif %}
            </td>
            <td>
              <span class="badge {{ {'ACTIVE':'badge-active','INACTIVE':'badge-inactive','NEEDS_REPAIR':'badge-repair','STOLEN':'badge-stolen'}.get(item.status.name, 'badge-active') }}">
                {{ item.status.name.replace('_', ' ').title() }}
              </span>
            </td>
            <td>{{ item.capture_date.strftime('%Y-%m-%d') if item.capture_date else '—' }}</td>
            <td class="actions">
              <a href="{{ url_for('capturer.edit_item', item_id=item.item_id) }}" class="btn btn-sm btn-edit">Edit</a>
              <a href="{{ url_for('capturer.move_item', item_id=item.item_id) }}" class="btn btn-sm btn-move">Move</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if items|length > 10 %}
      <button class="show-more-btn" id="showMoreBtn">Show All {{ items|length }} Items</button>
      {% endif %}

      {% if not items %}
      <div style="text-align:center;padding:4rem;color:#666;">
        <p>No items captured yet.</p>
        <a href="{{ url_for('capturer.bulk_capture', room_id=room.room_id) }}" class="btn btn-primary">Capture First Item</a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Show only first 10 rows initially
document.addEventListener('DOMContentLoaded', () => {
  const rows = document.querySelectorAll('.table-row');
  const showMoreBtn = document.getElementById('showMoreBtn');

  // Hide all after 10
  rows.forEach((row, index) => {
    if (index >= 10) row.style.display = 'none';
  });

  // Show More button
  if (showMoreBtn) {
    showMoreBtn.onclick = () => {
      rows.forEach(row => row.style.display = '');
      showMoreBtn.style.display = 'none';
    };
  }

  // Live Search + Filter
  const searchInput = document.getElementById('searchInput');
  const filterButtons = document.querySelectorAll('.search-filter-bar .btn-secondary');

  function applyFilters() {
    const term = searchInput.value.toLowerCase();
    const activeStatus = document.querySelector('.search-filter-bar .btn-secondary.active')?.dataset.status || '';

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const status = row.dataset.status;
      const matchesSearch = text.includes(term);
      const matchesStatus = (activeStatus === '' || status === activeStatus);

      row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    });
  }

  // Search as you type
  searchInput?.addEventListener('input', applyFilters);

  // Filter buttons
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    });
  });
});
</script>
{% endblock %}