{% extends "base.html" %}

{% block head_extras %}
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<style>
  :root{--dut-navy:#001F3F;--dut-maroon:#800000;--dut-light:#f8f9fa;--text-primary:#1a1a1a;--text-secondary:#555;--border-color:#e8eef5;--success:#198754;--danger:#dc3545;--warning:#ffc107;--info:#0dcaf0;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:linear-gradient(135deg,#f5f7fa 0%,#e9ecf1 100%);min-height:100vh;color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;}
  .container-fluid{max-width:1000px;padding:1rem;}

  .header-section{background:#fff;padding:1.75rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,31,63,.06);margin-bottom:2rem;border-top:4px solid var(--dut-navy);}
  .header-top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1.5rem;}
  .header-content h1{font-size:2rem;font-weight:700;color:var(--dut-navy);display:flex;align-items:center;gap:.75rem;margin:0;}
  .header-content h1 i{color:var(--dut-maroon);font-size:2rem;}

  .btn{padding:.75rem 1.5rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-flex;align-items:center;gap:.5rem;font-size:.95rem;}
  .btn-secondary{background:#fff;color:var(--dut-navy);border:2px solid var(--dut-navy);}
  .btn-secondary:hover{background:var(--dut-navy);color:#fff;}
  .btn-primary{background:var(--dut-maroon);color:#fff;width:100%;}
  .btn-primary:hover{background:#6a0000;transform:translateY(-2px);box-shadow:0 6px 16px rgba(128,0,0,.2);}
  .btn-success-sm{background:var(--success);color:#fff;padding:.5rem 1rem;font-size:.9rem;}
  .btn-success-sm:hover{background:#146c43;}

  .alert{border-radius:8px;border:none;padding:1rem 1.25rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap;}
  .alert-success{background:#d1e7dd;color:#0f5132;}
  .alert-danger{background:#f8d7da;color:#842029;}
  .alert-warning{background:#fff3cd;color:#664d03;}
  .btn-close{background:none;border:none;font-size:1.25rem;cursor:pointer;opacity:.6;margin-left:auto;}
  .btn-close:hover{opacity:1;}

  .card{background:#fff;border-radius:12px;border:1px solid var(--border-color);box-shadow:0 2px 8px rgba(0,0,0,.04);overflow:hidden;margin-bottom:1.5rem;}
  .card-header{background:linear-gradient(135deg,var(--dut-navy) 0%,#000d2e 100%);color:#fff;padding:1.5rem;}
  .card-header h5{margin:0;font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:.75rem;}
  .card-body{padding:1.75rem;}
  .item-details{background:linear-gradient(135deg,#f0f4fa 0%,#e8f0f8 100%);border-left:4px solid var(--dut-navy);}

  .highlight-badge{font-weight:700;padding:.35rem .75rem;border-radius:6px;color:#fff;display:inline-block;min-width:80px;text-align:center;}
  .highlight-from{background:var(--danger);}
  .highlight-to{background:var(--success);}
  .highlight-item{background:var(--dut-maroon);font-size:1.1rem;}

  .location-row{display:flex;align-items:center;gap:1rem;margin:1rem 0;}
  .location-label{font-weight:600;color:var(--dut-navy);min-width:110px;}
  .location-value{font-weight:500;}

  .item-detail-row{display:grid;grid-template-columns:auto 1fr;gap:1rem;margin-bottom:.75rem;align-items:start;}
  .item-detail-label{font-weight:700;color:var(--dut-navy);min-width:120px;}
  .item-detail-value{color:var(--text-primary);}
  .asset-tag{background:var(--dut-maroon);color:#fff;padding:.4rem .8rem;border-radius:6px;font-weight:700;font-family:'Courier New',monospace;display:inline-block;}

  .form-section{margin-bottom:2rem;}
  .form-section-header{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:.75rem;margin-bottom:1.25rem;padding-bottom:1rem;border-bottom:2px solid var(--border-color);}
  .form-section-header.from{color:var(--danger);}
  .form-section-header.to{color:var(--success);}
  .form-label{font-weight:600;color:var(--dut-navy);margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem;font-size:.95rem;}
  .form-control,.form-select{border:2px solid var(--border-color);border-radius:8px;padding:.875rem;font-size:1rem;color:var(--text-primary);transition:all .3s ease;width:100%;}
  .form-control:focus,.form-select:focus{border-color:var(--dut-navy);outline:none;box-shadow:0 0 0 3px rgba(0,31,63,.1);}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;}
  .form-row.full{grid-template-columns:1fr;}
  .form-group{display:flex;flex-direction:column;}
  .error-text{color:var(--danger);font-size:.85rem;margin-top:.5rem;display:flex;align-items:center;gap:.4rem;}
  .divider{height:1px;background:var(--border-color);margin:2rem 0;}
  .info-box{background:#cfe2ff;border-left:4px solid var(--info);padding:1rem;border-radius:8px;margin-bottom:1.5rem;font-size:.9rem;color:#084298;display:flex;gap:.75rem;}
  .info-box i{flex-shrink:0;margin-top:.1rem;}
  .warning-box{background:#fff3cd;border-left:4px solid var(--warning);padding:1rem;border-radius:8px;margin-bottom:1.5rem;font-size:.9rem;color:#664d03;display:flex;gap:.75rem;align-items:start;}
  .warning-box i{flex-shrink:0;margin-top:.1rem;color:#856404;}
  .warning-box strong{color:#dc3545;}
  .item-count-badge{background:var(--warning);color:#000;padding:.25rem .6rem;border-radius:4px;font-weight:700;font-size:.85rem;display:inline-block;}
  .step-number{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;background:var(--dut-navy);color:#fff;border-radius:50%;font-weight:700;font-size:.9rem;margin-right:.5rem;}

  @media (max-width:1024px){.form-row{grid-template-columns:1fr;gap:1.25rem;}}
  @media (max-width:768px){
    .container-fluid{padding:.75rem;}
    .header-section{padding:1.25rem;margin-bottom:1.5rem;}
    .header-top{flex-direction:column;gap:1rem;}
    .header-content h1{font-size:1.4rem;gap:.5rem;}
    .header-content h1 i{font-size:1.4rem;}
    .btn{width:100%;justify-content:center;}
    .card-body{padding:1.25rem;}
    .item-detail-row{grid-template-columns:1fr;gap:.5rem;}
    .item-detail-label{min-width:auto;color:var(--text-secondary);font-size:.85rem;}
    .location-row{flex-direction:column;align-items:flex-start;}
  }
  @media (max-width:480px){
    .header-content h1{font-size:1.2rem;}
    .btn{padding:.65rem 1rem;font-size:.85rem;}
    .asset-tag{padding:.3rem .6rem;font-size:.8rem;}
  }
  .btn:focus,a:focus{outline:2px solid var(--dut-navy);outline-offset:2px;}
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('{{ form.to_room.id }}');
    const preview = document.getElementById('dest-preview');

    function updatePreview() {
      const opt = select.options[select.selectedIndex];
      if (opt && opt.value && opt.value !== '0') {
        preview.textContent = opt.textContent;
        preview.parentElement.style.display = 'flex';
      } else {
        preview.parentElement.style.display = 'none';
      }
    }

    select.addEventListener('change', updatePreview);
    updatePreview();
  });
</script>
{% endblock %}

{% block title %}Move Item: {{ item.asset_number }}{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- BULLETPROOF BACK URL -->
  {% set back_url = (
      request.referrer
      if request.referrer and request.referrer.startswith(request.url_root + 'capturer/')
      else url_for('capturer.my_items')
  ) %}

  <!-- Header -->
  <div class="header-section">
    <div class="header-top">
      <div class="header-content">
        <h1><i class="fas fa-exchange-alt"></i>Move Item</h1>
      </div>
      <a href="{{ back_url }}" class="btn btn-secondary">
        <i class="fas fa-times-circle"></i>Cancel
      </a>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}" role="alert">
          <div style="flex:1;">
            <i class="fas fa-{% if category == 'danger' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            <span>{{ message | safe }}</span>
          </div>
          {% if category == 'success' and 'moved' in message %}
            <a href="{{ url_for('capturer.manage_room_items', room_id=item.room_id) }}"
               class="btn btn-success-sm">
              <i class="fas fa-arrow-right"></i> Go to New Room
            </a>
          {% endif %}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">×</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Item Summary -->
  <div class="card item-details">
    <div class="card-body">
      <h5 style="margin-bottom:1.25rem;color:var(--dut-navy);font-weight:700;display:flex;align-items:center;gap:.5rem;">
        <i class="fas fa-cube"></i>Item Being Moved
      </h5>

      <div class="item-detail-row">
        <div class="item-detail-label">Item:</div>
        <div class="item-detail-value">
          <span class="highlight-badge highlight-item">{{ item.name }}</span>
        </div>
      </div>

      <div class="item-detail-row">
        <div class="item-detail-label">Asset #:</div>
        <div class="item-detail-value"><span class="asset-tag">{{ item.asset_number }}</span></div>
      </div>

      <div class="location-row">
        <div class="location-label">From:</div>
        <div class="location-value">
          <span class="highlight-badge highlight-from">
            {{ current_room.campus.name }} → {{ current_room.name }}
          </span>
        </div>
      </div>

      <!-- DESTINATION PREVIEW (NAME ONLY) -->
      <div class="location-row" style="display:none;">
        <div class="location-label">To:</div>
        <div class="location-value">
          <span id="dest-preview" class="highlight-badge highlight-to"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Move Form -->
  <div class="card">
    <div class="card-header">
      <h5><i class="fas fa-clipboard-list"></i>Transfer Details</h5>
    </div>
    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}

        <div class="form-section">
          <div class="form-section-header full">
            <span class="step-number">1</span>Select Destination Room
          </div>
          <div class="form-group">
            <label for="{{ form.to_room.id }}" class="form-label">
              <i class="fas fa-door-open"></i>Destination Room
            </label>
            <select name="{{ form.to_room.name }}" id="{{ form.to_room.id }}" class="form-select">
              <option value="0">Select Destination Room</option>
              {% for room_id, room_name in form.to_room.choices[1:] %}
                <option value="{{ room_id }}"
                        {% if room_id == form.to_room.data %}selected{% endif %}>
                  {{ room_name }}
                </option>
              {% endfor %}
            </select>
            {% for error in form.to_room.errors %}
              <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="divider"></div>

        <div class="form-section">
          <div class="form-section-header from">
            <span class="step-number">2</span>
            <i class="fas fa-sign-out-alt"></i>Current Room Staff
          </div>
          
          <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>IMPORTANT:</strong> This room currently has 
              <span class="item-count-badge">{{ current_room.items|length }} items</span>. 
              Changing staff details here will affect <strong>ALL {{ current_room.items|length }} items</strong> in <strong>{{ current_room.name }}</strong>, 
              not just the item you're moving.
            </div>
          </div>
          
          <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <span>Only change these fields if the entire room's ownership is actually being transferred to someone else.</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              {{ form.source_staff_name.label(class="form-label") }}
              {{ form.source_staff_name(class="form-control", placeholder="Full name") }}
              {% for error in form.source_staff_name.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
            <div class="form-group">
              {{ form.source_staff_number.label(class="form-label") }}
              {{ form.source_staff_number(class="form-control", placeholder="e.g., 12345678") }}
              {% for error in form.source_staff_number.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="form-section">
          <div class="form-section-header to">
            <span class="step-number">3</span>
            <i class="fas fa-sign-in-alt"></i>New Room Staff
          </div>
          
          <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>IMPORTANT:</strong> Changing staff details here will affect 
              <strong>ALL items</strong> currently in the destination room, plus this item being moved.
            </div>
          </div>
          
          <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <span>Enter the staff who owns the destination room. This assigns ownership for the entire room and all its items.</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              {{ form.dest_staff_name.label(class="form-label") }}
              {{ form.dest_staff_name(class="form-control", placeholder="Full name") }}
              {% for error in form.dest_staff_name.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
            <div class="form-group">
              {{ form.dest_staff_number.label(class="form-label") }}
              {{ form.dest_staff_number(class="form-control", placeholder="e.g., 12345678") }}
              {% for error in form.dest_staff_number.errors %}
                <div class="error-text"><i class="fas fa-exclamation-circle"></i>{{ error }}</div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div style="margin-top:2rem;">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check-circle"></i>Confirm & Log Transfer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}